#!/usr/bin/env node
/**
 * Clean workspace: archive dev/temp leftovers and remove re-generated assets.
 * - Moves temp files into .archive/<timestamp>/
 * - Deletes the assets/ folder (re-generated by deploy)
 * - Moves per-audit JSONs at root to datasets/
 */
const fs = require('fs')
const path = require('path')

const root = process.cwd()
const trashRoot = path.join(root, '.archive')
const stamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T','_').slice(0,19)
const trash = path.join(trashRoot, stamp)

function ensureDir(p){ fs.mkdirSync(p, { recursive: true }) }
function move(src, dest){ ensureDir(path.dirname(dest)); fs.renameSync(src, dest) }
function rmrf(p){ if (fs.existsSync(p)) fs.rmSync(p, { recursive: true, force: true }) }

const candidates = [
  'audits.config - Copy.json',
  'settings_before.txt',
  'settings_tmp_before.tsx',
  'TEMP_App_preview.txt',
  'temp_snip.txt',
]

// tmp-*.js at root
fs.readdirSync(root).forEach((f) => {
  if (/^tmp-.*\.js$/i.test(f)) candidates.push(f)
})

ensureDir(trash)
let moved = 0
for (const rel of candidates){
  const src = path.join(root, rel)
  if (fs.existsSync(src)){
    const dest = path.join(trash, rel)
    try { move(src, dest); moved++; } catch (e) { console.error('Failed to move', rel, e.message) }
  }
}

// Remove re-generated assets folder
rmrf(path.join(root, 'assets'))

// Move known per-audit JSONs into datasets/
const datasetNames = ['adac.json','lcpc.json','poc.json','sglg.json','cflga.json']
const datasetsDir = path.join(root, 'datasets')
ensureDir(datasetsDir)
for (const name of datasetNames){
  const src = path.join(root, name)
  if (fs.existsSync(src)){
    const dest = path.join(datasetsDir, name)
    try { fs.renameSync(src, dest); console.log(`Moved ${name} -> datasets/`) } catch (e) { console.error('Failed to move', name, e.message) }
  }
}

console.log(`Clean complete. Archived ${moved} item(s) to ${path.relative(root, trash)}. Removed assets/ if present.`)
